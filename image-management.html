<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire d'Images - AutoSénégal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Ajouter dans le <head> de vos pages admin -->
    <script src="https://upload-widget.cloudinary.com/global/all.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cloudinary-core/2.11.4/cloudinary-core-shrinkwrap.min.js"></script>
    <script src="https://widget.cloudinary.com/v2.0/global/all.js" type="text/javascript"></script>


   <style>
        /* Variables et réinitialisation */
        :root {
            --primary-color: #007C5A; /* Vert, couleur du drapeau sénégalais */
            --secondary-color: #FFCE00; /* Jaune, couleur du drapeau sénégalais */
            --accent-color: #CF0921; /* Rouge, couleur du drapeau sénégalais */
            --light: #F5F5F5;
            --dark: #333333;
            --gray: #F0F2F5;
            --shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--gray);
            color: var(--dark);
            min-height: 100vh;
        }

        /* Header styles */
        .header {
            background-color: white;
            box-shadow: var(--shadow);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: var(--primary-color);
            font-weight: 700;
            font-size: 1.5rem;
        }

        .logo i {
            margin-right: 10px;
            font-size: 1.8rem;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-link {
            text-decoration: none;
            color: var(--dark);
            padding: 8px 12px;
            border-radius: 5px;
            transition: var(--transition);
        }

        .nav-link:hover {
            background-color: var(--light);
        }

        .nav-link.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* Main Content */
        .main-content {
            padding: 40px 0;
        }

        .page-title {
            margin-bottom: 30px;
            font-size: 2rem;
            color: var(--dark);
        }

        /* Image Management */
        .image-management-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .section-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .section-content {
            padding: 20px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            background-color: var(--light);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 20px;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
            flex-grow: 1;
        }

        .tab.active {
            background-color: var(--primary-color);
            color: white;
        }

        /* Image Upload */
        .upload-container {
            border: 2px dashed rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            background-color: var(--light);
            transition: var(--transition);
            margin-bottom: 30px;
        }

        .upload-container:hover {
            border-color: var(--primary-color);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .upload-text {
            margin-bottom: 20px;
        }

        .upload-text h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .upload-text p {
            color: #777;
        }

        .upload-btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            border: none;
            transition: var(--transition);
        }

        .upload-btn:hover {
            background-color: #006547;
        }

        .file-input {
            display: none;
        }

        /* Image Gallery */
        .images-filters {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .search-bar {
            display: flex;
            align-items: center;
            background-color: var(--light);
            border-radius: 50px;
            padding: 8px 15px;
            max-width: 400px;
            flex-grow: 1;
        }

        .search-bar input {
            border: none;
            background-color: transparent;
            outline: none;
            padding: 5px 10px;
            width: 100%;
        }

        .search-bar i {
            color: #777;
        }

        .filter-dropdown {
            position: relative;
        }

        .filter-btn {
            display: flex;
            align-items: center;
            padding: 8px 15px;
            background-color: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
        }

        .filter-btn:hover {
            background-color: var(--light);
        }

        .filter-btn i {
            margin-left: 8px;
        }

        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .image-card {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            transition: var(--transition);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .image-thumbnail {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .image-checkbox {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            background-color: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid rgba(0, 0, 0, 0.1);
            transition: var(--transition);
        }

        .image-checkbox.checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .image-checkbox.checked::after {
            content: '\f00c';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            color: white;
            font-size: 12px;
        }

        .image-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .image-action {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            color: var(--dark);
            border: none;
        }

        .image-action:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .image-info {
            padding: 15px;
        }

        .image-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .image-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #777;
        }

        /* Batch Actions */
        .batch-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
            background-color: var(--light);
            padding: 15px;
            border-radius: 5px;
        }

        .selected-count {
            font-size: 0.9rem;
            color: #777;
        }

        .batch-buttons {
            display: flex;
            gap: 10px;
        }

        .batch-btn {
            padding: 8px 15px;
            background-color: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .batch-btn:hover {
            background-color: var(--light);
        }

        .batch-btn.delete {
            color: #f44336;
        }

        .batch-btn.delete:hover {
            background-color: rgba(244, 67, 54, 0.1);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 5px;
            margin-top: 30px;
        }

        .pagination-btn {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            background-color: white;
            cursor: pointer;
            transition: var(--transition);
        }

        .pagination-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Image Categories */
        .categories-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-top: 30px;
        }

        .categories-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .category-card {
            background-color: var(--light);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: var(--transition);
        }

        .category-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .category-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .category-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .category-count {
            font-size: 0.9rem;
            color: #777;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 100%;
            max-width: 700px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: all 0.3s ease;
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #777;
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--accent-color);
        }

        .modal-body {
            padding: 20px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Image Detail View */
        .image-detail {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }

        .image-preview {
            flex-basis: 300px;
            flex-grow: 1;
        }

        .preview-img {
            width: 100%;
            height: auto;
            border-radius: 5px;
            box-shadow: var(--shadow);
        }

        .image-info-panel {
            flex-basis: 300px;
            flex-grow: 1;
        }

        .info-group {
            margin-bottom: 20px;
        }

        .info-label {
            font-weight: 600;
            margin-bottom: 5px;
            display: block;
        }

        .info-value {
            color: #777;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 5px;
            transition: var(--transition);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 124, 90, 0.1);
        }

        .form-helper {
            font-size: 0.8rem;
            color: #777;
            margin-top: 5px;
        }

        /* Messages d'état vide */
        .empty-gallery {
            text-align: center;
            padding: 40px 20px;
            color: #777;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .image-detail {
                flex-direction: column;
            }
            
            .nav-links {
                display: none;
            }
            
            .mobile-menu-btn {
                display: block;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <a href="admin-panel.html" class="logo">
                    <i class="fas fa-car"></i>
                    <span>AutoSénégal Admin</span>
                </a>
                <nav class="nav-links">
                    <a href="admin-panel.html" class="nav-link">Tableau de bord</a>
                    <a href="admin-panel.html#vehicles" class="nav-link">Véhicules</a>
                    <a href="image-management.html" class="nav-link active">Images</a>
                    <a href="admin-panel.html#reservations" class="nav-link">Réservations</a>
                    <a href="index.html" class="nav-link" target="_blank">Voir le site</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <h1 class="page-title">Gestionnaire d'Images</h1>

            <!-- Image Management Section -->
            <section class="image-management-section">
                <div class="section-header">
                    <h2 class="section-title">Bibliothèque d'Images</h2>
                </div>
                <div class="section-content">
                    <!-- Tabs -->
                    <div class="tabs">
                        <div class="tab active" data-tab="all">Toutes les images</div>
                        <div class="tab" data-tab="vehicles">Véhicules</div>
                        <div class="tab" data-tab="interiors">Intérieurs</div>
                        <div class="tab" data-tab="exteriors">Extérieurs</div>
                        <div class="tab" data-tab="others">Autres</div>
                    </div>

                    <!-- Upload Container -->
                    <!-- Section d'upload avec Cloudinary -->
<div class="upload-container" id="cloudinaryUploadArea">
    <div class="upload-icon">
      <i class="fas fa-cloud-upload-alt"></i>
    </div>
    <div class="upload-text">
      <h3>Télécharger des images</h3>
      <p>Glissez-déposez vos images ici ou cliquez pour sélectionner des fichiers</p>
    </div>
    <button class="upload-btn" id="cloudinaryUploadBtn">Parcourir les fichiers</button>
  </div>
  
  <!-- Ajouter un champ pour choisir la catégorie avant l'upload -->
  <div class="form-group" style="margin-bottom: 20px;">
    <label for="uploadCategory">Catégorie des images à télécharger</label>
    <select id="uploadCategory" class="form-control">
      <option value="vehicles">Véhicules</option>
      <option value="interiors">Intérieurs</option>
      <option value="exteriors">Extérieurs</option>
      <option value="others">Autres</option>
    </select>
  </div>

                    <!-- Images Filters -->
                    <div class="images-filters">
                        <div class="search-bar">
                            <i class="fas fa-search"></i>
                            <input type="text" placeholder="Rechercher des images...">
                        </div>
                        <div class="filter-dropdown">
                            <button class="filter-btn">
                                Trier par <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Image Gallery - Vidé car les images seront générées dynamiquement -->
                    <div class="image-gallery">
                        <!-- Le contenu sera généré dynamiquement par JavaScript -->
                    </div>

                    <!-- Batch Actions -->
                    <div class="batch-actions">
                        <div class="selected-count">0 images sélectionnées</div>
                        <div class="batch-buttons">
                            <button class="batch-btn" id="assignCategoryBtn" disabled>
                                <i class="fas fa-folder"></i> Assigner catégorie
                            </button>
                            <button class="batch-btn" id="downloadBtn" disabled>
                                <i class="fas fa-download"></i> Télécharger
                            </button>
                            <button class="batch-btn delete" id="deleteSelectedBtn" disabled>
                                <i class="fas fa-trash-alt"></i> Supprimer
                            </button>
                        </div>
                    </div>

                    <!-- Pagination -->
                    <div class="pagination">
                        <button class="pagination-btn" disabled><i class="fas fa-chevron-left"></i></button>
                        <button class="pagination-btn active">1</button>
                        <button class="pagination-btn">2</button>
                        <button class="pagination-btn">3</button>
                        <button class="pagination-btn"><i class="fas fa-chevron-right"></i></button>
                    </div>
                </div>
            </section>

            <!-- Categories Section - Vidée car le contenu sera généré dynamiquement -->
            <section class="categories-section">
                <div class="section-header">
                    <h2 class="section-title">Catégories d'Images</h2>
                    <button class="upload-btn" id="addCategoryBtn">
                        <i class="fas fa-plus"></i> Ajouter une catégorie
                    </button>
                </div>
                <div class="section-content">
                    <div class="categories-list">
                        <!-- Le contenu sera généré dynamiquement par JavaScript -->
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Image Detail Modal -->
    <div class="modal" id="imageDetailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Détails de l'image</h2>
                <button class="modal-close" id="closeImageDetailModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="image-detail">
                    <div class="image-preview">
                        <img src="" alt="" class="preview-img" id="previewImg">
                    </div>
                    <div class="image-info-panel">
                        <div class="info-group">
                            <label class="info-label">Nom du fichier</label>
                            <div class="info-value" id="fileName"></div>
                        </div>
                        <div class="info-group">
                            <label class="info-label">Type</label>
                            <div class="info-value" id="fileType"></div>
                        </div>
                        <div class="info-group">
                            <label class="info-label">Taille</label>
                            <div class="info-value" id="fileSize"></div>
                        </div>
                        <div class="info-group">
                            <label class="info-label">Dimensions</label>
                            <div class="info-value" id="fileDimensions"></div>
                        </div>
                        <div class="info-group">
                            <label class="info-label">Date d'ajout</label>
                            <div class="info-value" id="fileDate"></div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Texte alternatif</label>
                            <input type="text" class="form-control" id="altText">
                            <div class="form-helper">Description de l'image pour l'accessibilité</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Catégorie</label>
                            <select class="form-control" id="imageCategory">
                                <option value="vehicles">Véhicules</option>
                                <option value="interiors">Intérieurs</option>
                                <option value="exteriors">Extérieurs</option>
                                <option value="others">Autres</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="batch-btn" id="cancelImageDetail">Annuler</button>
                <button class="upload-btn" id="saveImageDetail">Enregistrer</button>
            </div>
        </div>
    </div>

    <!-- JavaScript - Système de gestion d'images dynamique -->
    <script>
// Nouveau code à mettre dans la balise <script> à la fin de image-management.html
// ==============================================
// SERVICE DE DONNÉES POUR AUTOSENEGAL
// ==============================================

// Clés de stockage localStorage
const STORAGE_KEYS = {
    IMAGES: 'autosenegal_images',
    VEHICLES: 'autosenegal_vehicles',
    CATEGORIES: 'autosenegal_categories',
    SETTINGS: 'autosenegal_settings'
};

// Configuration Cloudinary 
const cloudinaryConfig = {
    cloudName: 'diovja6qr', // Remplacer par le vôtre
    uploadPreset: 'ndiambour',   // À créer dans votre compte Cloudinary
    folder: 'ndiambour'          // Dossier dans votre compte Cloudinary
};

// Service de gestion des données unifié
const DataService = {
    // Initialiser les données si elles n'existent pas
    init: function() {
        // Images
        if (!localStorage.getItem(STORAGE_KEYS.IMAGES)) {
            localStorage.setItem(STORAGE_KEYS.IMAGES, JSON.stringify([]));
        }
        
        // Véhicules
        if (!localStorage.getItem(STORAGE_KEYS.VEHICLES)) {
            localStorage.setItem(STORAGE_KEYS.VEHICLES, JSON.stringify([]));
        }
        
        // Catégories d'images
        if (!localStorage.getItem(STORAGE_KEYS.CATEGORIES)) {
            const defaultCategories = [
                { id: 'vehicles', name: 'Véhicules', icon: 'fas fa-car', count: 0 },
                { id: 'interiors', name: 'Intérieurs', icon: 'fas fa-couch', count: 0 },
                { id: 'exteriors', name: 'Extérieurs', icon: 'fas fa-car-side', count: 0 },
                { id: 'others', name: 'Autres', icon: 'fas fa-images', count: 0 }
            ];
            localStorage.setItem(STORAGE_KEYS.CATEGORIES, JSON.stringify(defaultCategories));
        }
        
        // Paramètres
        if (!localStorage.getItem(STORAGE_KEYS.SETTINGS)) {
            localStorage.setItem(STORAGE_KEYS.SETTINGS, JSON.stringify({
                siteName: 'Ndiambour Location',
                currency: 'FCFA',
                language: 'fr'
            }));
        }
        
        console.log('DataService: Données initialisées');
    },
    
    // =============== GESTION DES IMAGES ===============
    
    // Récupérer toutes les images
    getAllImages: function() {
        return JSON.parse(localStorage.getItem(STORAGE_KEYS.IMAGES) || '[]');
    },
    
    // Récupérer les images par catégorie
    getImagesByCategory: function(category) {
        const images = this.getAllImages();
        return category === 'all' ? images : images.filter(img => img.category === category);
    },
    
    // Récupérer les images par véhicule
    getImagesByVehicle: function(vehicleId) {
        const images = this.getAllImages();
        return images.filter(img => img.vehicleId === vehicleId);
    },
    
    // Récupérer une image par ID
    getImageById: function(imageId) {
        const images = this.getAllImages();
        return images.find(img => img.id === imageId);
    },
    
    // Ajouter une image (adaptée pour Cloudinary)
    addImage: function(file, metadata = {}) {
        try {
            const images = this.getAllImages();
            
            // Générer un ID unique
            const imageId = metadata.id || 'img-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
            
            // Créer l'objet image
            const imageData = {
                id: imageId,
                fileName: metadata.fileName || file.name,
                fileType: metadata.fileType || (file.type ? file.type.split('/')[1].toUpperCase() : 'UNKNOWN'),
                category: metadata.category || 'others',
                alt: metadata.alt || file.name,
                src: metadata.src || '', // URL Cloudinary
                size: metadata.size || this.formatFileSize(file.size),
                dimensions: metadata.dimensions || 'Unknown',
                vehicleId: metadata.vehicleId || null,
                vehicleName: metadata.vehicleName || '',
                dateAdded: new Date().toISOString(),
                // Ajouter des informations spécifiques à Cloudinary
                isCloudinary: metadata.src && metadata.src.includes('cloudinary.com'),
                publicId: metadata.publicId || this.extractPublicIdFromUrl(metadata.src)
            };
            
            // Ajouter l'image à la collection
            images.push(imageData);
            localStorage.setItem(STORAGE_KEYS.IMAGES, JSON.stringify(images));
            
            // Mettre à jour le compteur de catégorie
            this.updateCategoryCount(imageData.category, 1);
            
            // Si l'image est associée à un véhicule, mettre à jour le véhicule
            if (imageData.vehicleId) {
                this.addImageToVehicle(imageId, imageData.vehicleId);
            }
            
            return imageData;
        } catch (error) {
            console.error("Erreur lors de l'ajout de l'image:", error);
            return null;
        }
    },
    
    // Extraire le publicId d'une URL Cloudinary
    extractPublicIdFromUrl: function(url) {
        if (!url || !url.includes('cloudinary.com')) return null;
        
        try {
            // Format typique: https://res.cloudinary.com/cloudName/image/upload/v1234567890/folder/publicId.ext
            const uploadIndex = url.indexOf('/upload/');
            if (uploadIndex === -1) return null;
            
            // Récupérer la partie après /upload/
            const pathPart = url.substring(uploadIndex + 8);
            
            // Supprimer la version si présente (v1234567890/)
            const versionMatch = pathPart.match(/^v\d+\//);
            const pathWithoutVersion = versionMatch ? pathPart.substring(versionMatch[0].length) : pathPart;
            
            // Récupérer le publicId (sans l'extension)
            const extensionIndex = pathWithoutVersion.lastIndexOf('.');
            const publicId = extensionIndex !== -1 
                ? pathWithoutVersion.substring(0, extensionIndex) 
                : pathWithoutVersion;
            
            return publicId;
        } catch (error) {
            console.error("Erreur lors de l'extraction du publicId:", error);
            return null;
        }
    },
    
    // Mettre à jour une image
    updateImage: function(imageId, updates) {
        const images = this.getAllImages();
        const index = images.findIndex(img => img.id === imageId);
        
        if (index === -1) return null;
        
        const oldImage = images[index];
        const updatedImage = {...oldImage, ...updates};
        
        // Si la catégorie a changé, mettre à jour les compteurs
        if (updates.category && updates.category !== oldImage.category) {
            this.updateCategoryCount(oldImage.category, -1);
            this.updateCategoryCount(updates.category, 1);
        }
        
        // Si le véhicule a changé, mettre à jour les associations
        if (updates.vehicleId !== undefined && updates.vehicleId !== oldImage.vehicleId) {
            if (oldImage.vehicleId) {
                this.removeImageFromVehicle(imageId, oldImage.vehicleId);
            }
            if (updates.vehicleId) {
                this.addImageToVehicle(imageId, updates.vehicleId);
            }
        }
        
        images[index] = updatedImage;
        localStorage.setItem(STORAGE_KEYS.IMAGES, JSON.stringify(images));
        
        return updatedImage;
    },
    
    // Supprimer une image
    deleteImage: function(imageId) {
        const images = this.getAllImages();
        const index = images.findIndex(img => img.id === imageId);
        
        if (index === -1) return false;
        
        const deletedImage = images[index];
        images.splice(index, 1);
        localStorage.setItem(STORAGE_KEYS.IMAGES, JSON.stringify(images));
        
        // Mettre à jour le compteur de catégorie
        this.updateCategoryCount(deletedImage.category, -1);
        
        // Si l'image était liée à un véhicule, mettre à jour
        if (deletedImage.vehicleId) {
            this.removeImageFromVehicle(imageId, deletedImage.vehicleId);
        }
        
        return true;
    },
    
    // =============== GESTION DES CATÉGORIES ===============
    
    // Récupérer toutes les catégories
    getAllCategories: function() {
        return JSON.parse(localStorage.getItem(STORAGE_KEYS.CATEGORIES) || '[]');
    },
    
    // Mettre à jour le compteur d'une catégorie
    updateCategoryCount: function(categoryId, delta) {
        const categories = this.getAllCategories();
        const index = categories.findIndex(cat => cat.id === categoryId);
        
        if (index === -1) return false;
        
        categories[index].count += delta;
        if (categories[index].count < 0) categories[index].count = 0;
        
        localStorage.setItem(STORAGE_KEYS.CATEGORIES, JSON.stringify(categories));
        return true;
    },
    
    // =============== GESTION DES VÉHICULES ===============
    
    // Récupérer tous les véhicules
    getAllVehicles: function() {
        return JSON.parse(localStorage.getItem(STORAGE_KEYS.VEHICLES) || '[]');
    },
    
    // Récupérer un véhicule par ID
    getVehicleById: function(vehicleId) {
        const vehicles = this.getAllVehicles();
        return vehicles.find(v => v.id === vehicleId);
    },
    
    // Ajouter une image à un véhicule
    addImageToVehicle: function(imageId, vehicleId) {
        const vehicles = this.getAllVehicles();
        const vehicleIndex = vehicles.findIndex(v => v.id === vehicleId);
        
        if (vehicleIndex === -1) return false;
        
        // Initialiser le tableau d'images si nécessaire
        if (!vehicles[vehicleIndex].images) {
            vehicles[vehicleIndex].images = [];
        }
        
        // Ajouter l'ID de l'image s'il n'existe pas déjà
        if (!vehicles[vehicleIndex].images.includes(imageId)) {
            vehicles[vehicleIndex].images.push(imageId);
            localStorage.setItem(STORAGE_KEYS.VEHICLES, JSON.stringify(vehicles));
            
            // Mettre à jour l'image avec les infos du véhicule
            const vehicle = vehicles[vehicleIndex];
            this.updateImage(imageId, {
                vehicleId: vehicleId,
                vehicleName: `${vehicle.make} ${vehicle.model} ${vehicle.year || ''}`
            });
        }
        
        return true;
    },
    
    // Supprimer une image d'un véhicule
    removeImageFromVehicle: function(imageId, vehicleId) {
        const vehicles = this.getAllVehicles();
        const vehicleIndex = vehicles.findIndex(v => v.id === vehicleId);
        
        if (vehicleIndex === -1 || !vehicles[vehicleIndex].images) return false;
        
        const imageIndex = vehicles[vehicleIndex].images.indexOf(imageId);
        if (imageIndex > -1) {
            vehicles[vehicleIndex].images.splice(imageIndex, 1);
            localStorage.setItem(STORAGE_KEYS.VEHICLES, JSON.stringify(vehicles));
            
            // Mettre à jour l'image pour supprimer l'association
            this.updateImage(imageId, {vehicleId: null, vehicleName: ''});
        }
        
        return true;
    },
    
    // =============== UTILITAIRES ===============
    
    // Formatter la taille de fichier
    formatFileSize: function(bytes) {
        if (bytes === undefined || bytes === null) return 'Inconnu';
        if (bytes === 0) return '0 Bytes';
        
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
};

// ==============================================
// FONCTIONS DE L'INTERFACE UTILISATEUR
// ==============================================

// Configuration du widget d'upload Cloudinary
function setupCloudinaryUpload() {
    const uploadBtn = document.getElementById('cloudinaryUploadBtn');
    if (!uploadBtn) {
        console.error("Bouton d'upload Cloudinary non trouvé");
        return;
    }
    
    console.log("Configuration du bouton d'upload Cloudinary");
    
    uploadBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log("Bouton d'upload Cloudinary cliqué");
        
        // Vérifier si Cloudinary est disponible
        if (typeof cloudinary === 'undefined') {
            console.error("L'API Cloudinary n'est pas disponible");
            alert("Service d'upload non disponible. Veuillez actualiser la page et réessayer.");
            return;
        }
        
        // Obtenir la catégorie sélectionnée
        const categorySelect = document.getElementById('uploadCategory');
        const selectedCategory = categorySelect ? categorySelect.value : 'others';
        
        console.log("Catégorie sélectionnée:", selectedCategory);
        
        // Options d'upload
        const uploadOptions = {
            cloudName: cloudinaryConfig.cloudName,
            uploadPreset: cloudinaryConfig.uploadPreset,
            folder: cloudinaryConfig.folder,
            multiple: true,
            maxFiles: 10,
            sources: ['local', 'url', 'camera'],
            resourceType: 'image',
            clientAllowedFormats: ['jpg', 'jpeg', 'png', 'webp'],
            maxFileSize: 5000000, // 5MB
            tags: [selectedCategory],
            context: { category: selectedCategory },
            styles: {
                palette: {
                    window: "#FFFFFF",
                    sourceBg: "#F0F2F5",
                    windowBorder: "#90A0B3",
                    tabIcon: "#1565C0",
                    inactiveTabIcon: "#69778A",
                    menuIcons: "#1565C0",
                    link: "#0078FF",
                    action: "#1565C0",
                    inProgress: "#0078FF",
                    complete: "#20B832",
                    error: "#FF3030",
                    textDark: "#000000",
                    textLight: "#FFFFFF"
                }
            },
            language: 'fr',
            text: {
                'fr': {
                    'local': {
                        'browse': 'Parcourir',
                        'dd_title_single': 'Glissez-déposez une image',
                        'dd_title_multi': 'Glissez-déposez des images',
                        'drop_title_single': 'Déposez une image',
                        'drop_title_multiple': 'Déposez des images'
                    }
                }
            }
        };
        
        // Ouvrir le widget directement (sans passer par CloudinaryService)
        cloudinary.openUploadWidget(uploadOptions, function(error, result) {
            console.log("Callback Cloudinary invoqué", error, result);
            
            if (error) {
                console.error("Erreur Cloudinary:", error);
                // Ne pas afficher d'alerte pour les annulations de l'utilisateur
                if (error.message !== "User closed widget") {
                    alert("Une erreur est survenue lors de l'upload. Veuillez réessayer.");
                }
                return;
            }
            
            // Vérifier si l'événement est un succès d'upload
            if (result && result.event === "success") {
                // Une image a été téléchargée avec succès
                const imageInfo = result.info;
                console.log("Upload réussi:", imageInfo);
                
                // Créer un objet de métadonnées pour l'image
                const metadata = {
                    src: imageInfo.secure_url,
                    fileName: imageInfo.original_filename,
                    fileType: imageInfo.format.toUpperCase(),
                    size: DataService.formatFileSize(imageInfo.bytes),
                    dimensions: `${imageInfo.width} × ${imageInfo.height}`,
                    category: selectedCategory,
                    alt: imageInfo.original_filename,
                    publicId: imageInfo.public_id
                };
                
                // Créer un faux objet File pour la compatibilité
                const fakeFile = {
                    name: imageInfo.original_filename,
                    type: `image/${imageInfo.format}`,
                    size: imageInfo.bytes
                };
                
                // Ajouter l'image à DataService
                const addedImage = DataService.addImage(fakeFile, metadata);
                console.log('Image ajoutée à la base de données:', addedImage);
                
                // Mettre à jour l'affichage
                renderImageGallery();
                
                // Notification
                alert('Image téléchargée avec succès !');
            }
        });
    });
    
    console.log("Bouton d'upload Cloudinary configuré avec succès");
}

// Configuration de la galerie d'images
function setupImageGallery() {
    // Configurer les onglets de catégorie
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach(tab => {
        tab.addEventListener('click', function() {
            // Retirer la classe active de tous les onglets
            tabs.forEach(t => t.classList.remove('active'));
            
            // Ajouter la classe active à l'onglet cliqué
            this.classList.add('active');
            
            // Filtrer les images par catégorie
            const category = this.getAttribute('data-tab');
            renderImageGallery(category);
        });
    });
    
    // Afficher initialement toutes les images
    renderImageGallery();
}

// Rendu de la galerie d'images
function renderImageGallery(category = 'all') {
    const imageGallery = document.querySelector('.image-gallery');
    if (!imageGallery) return;
    
    // Vider la galerie
    imageGallery.innerHTML = '';
    
    // Obtenir les images à afficher
    const images = DataService.getImagesByCategory(category);
    
    if (images.length === 0) {
        // Afficher un message si aucune image n'est disponible
        imageGallery.innerHTML = `
            <div class="empty-gallery">
                <i class="fas fa-images" style="font-size: 3rem; color: #ccc; margin-bottom: 15px;"></i>
                <p>Aucune image disponible dans cette catégorie.</p>
                <p>Utilisez le bouton "Parcourir les fichiers" pour ajouter des images.</p>
            </div>
        `;
        return;
    }
    
    // Générer une carte pour chaque image
    images.forEach(image => {
        const imageCard = createImageCard(image);
        imageGallery.appendChild(imageCard);
    });
    
    // Mettre à jour le compteur d'images sélectionnées
    updateSelectedCount();
}

// Créer une carte d'image
function createImageCard(image) {
    // Créer l'élément div pour la carte
    const card = document.createElement('div');
    card.className = 'image-card';
    card.setAttribute('data-category', image.category);
    card.setAttribute('data-id', image.id);
    
    // Définir le contenu HTML de la carte
    card.innerHTML = `
        <img src="${image.src}" alt="${image.alt}" class="image-thumbnail" 
             onerror="this.src='https://via.placeholder.com/150x100?text=Image+non+disponible'">
        <div class="image-checkbox" data-id="${image.id}"></div>
        <div class="image-actions">
            <button class="image-action" title="Voir" data-image-id="${image.id}"><i class="fas fa-eye"></i></button>
            <button class="image-action" title="Éditer" data-image-id="${image.id}"><i class="fas fa-edit"></i></button>
            <button class="image-action" title="Supprimer" data-image-id="${image.id}"><i class="fas fa-trash-alt"></i></button>
        </div>
        <div class="image-info">
            <h3 class="image-title">${image.fileName}</h3>
            <div class="image-meta">
                <span>${image.fileType} • ${image.size}</span>
                <span>${image.dimensions}</span>
            </div>
        </div>
    `;
    
    // Configurer les événements pour les boutons d'action
    setupImageCardEvents(card);
    
    return card;
}

// Configuration des événements pour une carte d'image
function setupImageCardEvents(cardElement) {
    // Checkbox pour sélection
    const checkbox = cardElement.querySelector('.image-checkbox');
    if (checkbox) {
        checkbox.addEventListener('click', function() {
            this.classList.toggle('checked');
            updateSelectedCount();
        });
    }
    
    // Boutons d'action
    const actionButtons = cardElement.querySelectorAll('.image-action');
    actionButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const action = this.getAttribute('title');
            const imageId = this.getAttribute('data-image-id');
            
            switch(action) {
                case 'Voir':
                    openImageDetailModal(imageId);
                    break;
                case 'Éditer':
                    openImageEditModal(imageId);
                    break;
                case 'Supprimer':
                    confirmImageDeletion(imageId, this);
                    break;
            }
        });
    });
}

// Mettre à jour le compteur d'images sélectionnées
function updateSelectedCount() {
    const checkedBoxes = document.querySelectorAll('.image-checkbox.checked');
    const countElement = document.querySelector('.selected-count');
    const batchButtons = document.querySelectorAll('.batch-buttons button');
    
    if (countElement) {
        const count = checkedBoxes.length;
        countElement.textContent = `${count} image${count !== 1 ? 's' : ''} sélectionnée${count !== 1 ? 's' : ''}`;
    }
    
    // Activer/désactiver les boutons d'action par lot
    batchButtons.forEach(button => {
        button.disabled = checkedBoxes.length === 0;
    });
}

// Ouvrir le modal de détails d'image
function openImageDetailModal(imageId) {
    const modal = document.getElementById('imageDetailModal');
    if (!modal) return;
    
    const image = DataService.getImageById(imageId);
    if (!image) return;
    
    // Mettre à jour le contenu du modal
    const previewImg = document.getElementById('previewImg');
    const fileName = document.getElementById('fileName');
    const fileType = document.getElementById('fileType');
    const fileSize = document.getElementById('fileSize');
    const fileDimensions = document.getElementById('fileDimensions');
    const fileDate = document.getElementById('fileDate');
    const altText = document.getElementById('altText');
    const imageCategory = document.getElementById('imageCategory');
    
    if (previewImg) previewImg.src = image.src;
    if (fileName) fileName.textContent = image.fileName;
    if (fileType) fileType.textContent = image.fileType;
    if (fileSize) fileSize.textContent = image.size;
    if (fileDimensions) fileDimensions.textContent = image.dimensions;
    if (fileDate) {
        // Formatage de la date
        const date = new Date(image.dateAdded);
        fileDate.textContent = date.toLocaleDateString('fr-FR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
    if (altText) altText.value = image.alt;
    if (imageCategory) {
        const options = imageCategory.querySelectorAll('option');
        options.forEach(option => {
            option.selected = option.value === image.category;
        });
    }
    
    // Ajouter l'ID de l'image au modal pour le récupérer lors de la sauvegarde
    modal.setAttribute('data-image-id', image.id);
    
    // Afficher le modal
    modal.classList.add('active');
}

// Ouvrir le modal d'édition d'image
function openImageEditModal(imageId) {
    // Utiliser le même modal que pour les détails
    openImageDetailModal(imageId);
}

// Confirmer la suppression d'une image
function confirmImageDeletion(imageId, buttonElement) {
    const image = DataService.getImageById(imageId);
    if (!image) return;
    
    if (confirm(`Êtes-vous sûr de vouloir supprimer l'image "${image.fileName}" ?`)) {
        // Supprimer l'image de la base de données
        const success = DataService.deleteImage(imageId);
        
        if (success) {
            // Supprimer la carte de l'image de l'interface
            const imageCard = buttonElement.closest('.image-card');
            if (imageCard) {
                imageCard.remove();
            }
            
            // Mettre à jour le compteur
            updateSelectedCount();
            
            alert(`Image "${image.fileName}" supprimée avec succès!`);
        } else {
            alert("Erreur lors de la suppression de l'image.");
        }
    }
}

// Configuration des modals
function setupModals() {
    const imageDetailModal = document.getElementById('imageDetailModal');
    const closeImageDetailModal = document.getElementById('closeImageDetailModal');
    const cancelImageDetail = document.getElementById('cancelImageDetail');
    const saveImageDetail = document.getElementById('saveImageDetail');
    
    if (closeImageDetailModal && imageDetailModal) {
        closeImageDetailModal.addEventListener('click', () => {
            imageDetailModal.classList.remove('active');
        });
    }
    
    if (cancelImageDetail && imageDetailModal) {
        cancelImageDetail.addEventListener('click', () => {
            imageDetailModal.classList.remove('active');
        });
    }
    
    if (saveImageDetail && imageDetailModal) {
        saveImageDetail.addEventListener('click', (event) => {
            event.preventDefault();
            
            const imageId = imageDetailModal.getAttribute('data-image-id');
            if (!imageId) return;
            
            // Récupérer les nouvelles valeurs
            const altText = document.getElementById('altText')?.value;
            const imageCategory = document.getElementById('imageCategory')?.value;
            
            // Mettre à jour l'image
            const updatedImage = DataService.updateImage(imageId, {
                alt: altText,
                category: imageCategory
            });
            
            if (updatedImage) {
                // Mettre à jour l'interface
                renderImageGallery();
                
                // Fermer le modal
                imageDetailModal.classList.remove('active');
                
                alert('Modifications enregistrées avec succès!');
            } else {
                alert("Erreur lors de la mise à jour de l'image.");
            }
        });
    }
    
    // Fermer les modals en cliquant à l'extérieur
    window.addEventListener('click', (e) => {
        if (imageDetailModal && e.target === imageDetailModal) {
            imageDetailModal.classList.remove('active');
        }
    });
}

// Configuration de la recherche
function setupSearch() {
    const searchInput = document.querySelector('.search-bar input');
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            const searchText = this.value.toLowerCase();
            
            const imageCards = document.querySelectorAll('.image-card');
            
            imageCards.forEach(card => {
                if (searchText === '') {
                    card.style.display = '';
                    return;
                }
                
                const titleElement = card.querySelector('.image-title');
                const metaElement = card.querySelector('.image-meta');
                
                if (!titleElement) return;
                
                const title = titleElement.textContent.toLowerCase();
                const meta = metaElement ? metaElement.textContent.toLowerCase() : '';
                
                if (title.includes(searchText) || meta.includes(searchText)) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    }
}

// Initialiser quand le DOM est chargé
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM chargé, initialisation...");
  
    // Vérification du chargement des scripts Cloudinary
    if (typeof cloudinary === 'undefined') {
        console.log("Cloudinary n'est pas chargé, tentative de chargement...");
        
        // Charge le widget d'upload Cloudinary s'il n'est pas déjà chargé
        const cloudinaryWidgetScript = document.createElement('script');
        cloudinaryWidgetScript.src = 'https://upload-widget.cloudinary.com/global/all.js';
        cloudinaryWidgetScript.type = 'text/javascript';
        cloudinaryWidgetScript.onload = function() {
            console.log("Script Cloudinary widget chargé avec succès");
            
            // Charge le script core de Cloudinary
            const cloudinaryCoreScript = document.createElement('script');
            cloudinaryCoreScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/cloudinary-core/2.11.4/cloudinary-core-shrinkwrap.min.js';
            cloudinaryCoreScript.type = 'text/javascript';
            cloudinaryCoreScript.onload = function() {
                console.log("Script Cloudinary core chargé avec succès");
                
                // Initialiser l'application une fois les scripts chargés
                initApp();
            };
            document.head.appendChild(cloudinaryCoreScript);
        };
        document.head.appendChild(cloudinaryWidgetScript);
    } else {
        console.log("Cloudinary déjà chargé");
        initApp();
    }
    
    // Fonction d'initialisation de l'application
    function initApp() {
        // Initialiser les données
        DataService.init();
        
        // Configurer l'interface utilisateur
        setupCloudinaryUpload();
        setupImageGallery();
        setupModals();
        setupSearch();
        
        // Charger les images au démarrage
        renderImageGallery();
        
        console.log("Application initialisée avec succès");
    }
});

</script>
</body>
</html>